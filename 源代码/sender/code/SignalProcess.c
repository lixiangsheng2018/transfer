#include "Sender.h"
#include "arm_math.h"
#include "arm_const_structs.h"
#if (DENOISE_PROCESS == DENOISE_WEBRTC)
#include "NsLib.h"
#endif

#define SIGNAL_PROCESS   0

#define BLOCK_SIZE       DATALEN_PER_RAWFRAME

#if (SIGNAL_PROCESS)
float32_t FIR_InputBuffer[BLOCK_SIZE];
float32_t FIR_OutputBuffer[BLOCK_SIZE];
#endif

#if (SIGNAL_PROCESS & 0x01)
/* ----------------------------------------------------------------------
** Q31 state buffers for Band1, Band2, Band3, Band4, Band5
** ------------------------------------------------------------------- */
#define NUMSTAGES 2
static q63_t biquadStateBand1Q31[4 * 2];
static q63_t biquadStateBand2Q31[4 * 2];
static q31_t biquadStateBand3Q31[4 * 2];
static q31_t biquadStateBand4Q31[4 * 2];
static q31_t biquadStateBand5Q31[4 * 2];

/* ----------------------------------------------------------------------
** Q31 input and output buffers
** ------------------------------------------------------------------- */

q31_t inputQ31[BLOCK_SIZE];
q31_t outputQ31[BLOCK_SIZE];

/* ----------------------------------------------------------------------
** Entire coefficient table.  There are 10 coefficients per 4th order Biquad
** cascade filter.  The first 10 coefficients correspond to the -9 dB gain
** setting of band 1; the next 10 coefficient correspond to the -8 dB gain
** setting of band 1; and so on.  There are 10*19=190 coefficients in total
** for band 1 (gains = -9, -8, -7, ..., 9).  After this come the 190 coefficients
** for band 2.
**
** The coefficients are in Q29 format and require a postShift of 2.
** bands[100, 500, 2000, 6000]
** ------------------------------------------------------------------- */

const q31_t coeffTable[950] = {

    /* Band 1, -9 dB gain */
    535576962, -1071153923, 535576962, 1073741824, -536870912, 535576962, -1063501998, 527979313, 1060865294, -524146981,
    /* Band 1, -8 dB gain */
    535723226, -1071446451, 535723226, 1073741824, -536870912, 535723226, -1063568947, 527903217, 1061230578, -524503778,
    535868593, -1071737186, 535868593, 1073741824, -536870912, 535868593, -1063627467, 527819780, 1061585502, -524850686,
    536013181, -1072026363, 536013181, 1073741824, -536870912, 536013181, -1063677598, 527728935, 1061930361, -525187972,
    536157109, -1072314217, 536157109, 1073741824, -536870912, 536157109, -1063719372, 527630607, 1062265438, -525515897,
    536300492, -1072600983, 536300492, 1073741824, -536870912, 536300492, -1063752815, 527524720, 1062591011, -525834716,
    536443447, -1072886894, 536443447, 1073741824, -536870912, 536443447, -1063777945, 527411186, 1062907350, -526144676,
    536586091, -1073172183, 536586091, 1073741824, -536870912, 536586091, -1063794775, 527289917, 1063214717, -526446017,
    536728541, -1073457082, 536728541, 1073741824, -536870912, 536728541, -1063803308, 527160815, 1063513366, -526738975,
    536870912, -1073741824, 536870912, 1073741824, -536870912, 536870912, -1063803543, 527023777, 1063803543, -527023777,
    537013321, -1074026642, 537013321, 1073741824, -536870912, 537013321, -1063795470, 526878696, 1064085490, -527300648,
    537155884, -1074311768, 537155884, 1073741824, -536870912, 537155884, -1063779073, 526725455, 1064359439, -527569803,
    537298718, -1074597435, 537298718, 1073741824, -536870912, 537298718, -1063754328, 526563934, 1064625617, -527831454,
    537441939, -1074883878, 537441939, 1073741824, -536870912, 537441939, -1063721205, 526394005, 1064884245, -528085806,
    537585666, -1075171331, 537585666, 1073741824, -536870912, 537585666, -1063679666, 526215534, 1065135536, -528333059,
    537730015, -1075460030, 537730015, 1073741824, -536870912, 537730015, -1063629666, 526028380, 1065379699, -528573409,
    537875106, -1075750212, 537875106, 1073741824, -536870912, 537875106, -1063571152, 525832396, 1065616936, -528807045,
    538021057, -1076042114, 538021057, 1073741824, -536870912, 538021057, -1063504065, 525627429, 1065847444, -529034151,
    538167989, -1076335977, 538167989, 1073741824, -536870912, 538167989, -1063428338, 525413317, 1066071412, -529254907,

    /* Band 2, -9 dB gain */
    531784976, -1055497692, 523873415, 1066213307, -529420241, 531784976, -1040357886, 509828014, 1028908252, -494627367,
    /* Band 2, -8 dB gain */
    532357636, -1056601982, 524400080, 1066115844, -529326645, 532357636, -1040623406, 509562600, 1030462237, -496062122,
    532927392, -1057707729, 524931110, 1066024274, -529239070, 532927392, -1040848253, 509262081, 1031969246, -497457090,
    533494678, -1058816094, 525467240, 1065939047, -529157961, 533494678, -1041032161, 508925950, 1033429976, -498812573,
    534059929, -1059928204, 526009170, 1065860582, -529083734, 534059929, -1041174868, 508553717, 1034845124, -500128887,
    534623580, -1061045148, 526557561, 1065789260, -529016764, 534623580, -1041276126, 508144920, 1036215393, -501406373,
    535186068, -1062167969, 527113032, 1065725420, -528957385, 535186068, -1041335703, 507699125, 1037541500, -502645399,
    535747827, -1063297666, 527676151, 1065669351, -528905879, 535747827, -1041353386, 507215934, 1038824183, -503846368,
    536309295, -1064435183, 528247436, 1065621289, -528862476, 536309295, -1041328990, 506694984, 1040064203, -505009724,
    536870912, -1065581413, 528827349, 1065581413, -528827349, 536870912, -1041262354, 506135953, 1041262354, -506135953,
    537433117, -1066737194, 529416295, 1065549847, -528800610, 537433117, -1041153346, 505538564, 1042419457, -507225588,
    537996352, -1067903307, 530014622, 1065526651, -528782316, 537996352, -1041001864, 504902578, 1043536370, -508279208,
    538561061, -1069080480, 530622620, 1065511830, -528772462, 538561061, -1040807833, 504227800, 1044613981, -509297437,
    539127690, -1070269387, 531240527, 1065505333, -528770987, 539127690, -1040571205, 503514074, 1045653211, -510280946,
    539696690, -1071470656, 531868525, 1065507054, -528777778, 539696690, -1040291951, 502761277, 1046655011, -511230450,
    540268512, -1072684867, 532506750, 1065516837, -528792672, 540268512, -1039970063, 501969320, 1047620358, -512146700,
    540843613, -1073912567, 533155297, 1065534483, -528815459, 540843613, -1039605542, 501138139, 1048550251, -513030484,
    541422451, -1075154268, 533814224, 1065559750, -528845892, 541422451, -1039198394, 500267687, 1049445708, -513882621,
    542005489, -1076410460, 534483561, 1065592362, -528883686, 542005489, -1038748624, 499357932, 1050307760, -514703956,
    
    518903861, -1001986830, 486725277, 1037235801, -502367695, 518903861, -945834422, 446371043, 902366163, -400700571,
    520899989, -1005630916, 488289126, 1036926846, -502147311, 520899989, -946490935, 445581846, 907921945, -404936158,
    522893209, -1009290002, 489869792, 1036650484, -501961419, 522893209, -947006359, 444685310, 913306106, -409075225,
    524884763, -1012968199, 491470256, 1036407567, -501810737, 524884763, -947377809, 443679533, 918521018, -413116221,
    526875910, -1016669649, 493093518, 1036198712, -501695739, 526875910, -947602324, 442562672, 923569247, -417057897,
    528867927, -1020398503, 494742575, 1036024293, -501616651, 528867927, -947676875, 441332970, 928453558, -420899319,
    530862111, -1024158905, 496420407, 1035884447, -501573457, 530862111, -947598385, 439988777, 933176909, -424639872,
    532859778, -1027954970, 498129955, 1035779077, -501565907, 532859778, -947363742, 438528571, 937742446, -428279254,
    534862260, -1031790763, 499874098, 1035707863, -501593525, 534862260, -946969823, 436950987, 942153486, -431817474,
    536870912, -1035670279, 501655630, 1035670279, -501655630, 536870912, -946413508, 435254839, 946413508, -435254839,
    538887107, -1039597419, 503477238, 1035665609, -501751354, 538887107, -945691703, 433439146, 950526127, -438591937,
    540912240, -1043575967, 505341475, 1035692963, -501879659, 540912240, -944801359, 431503152, 954495080, -441829621,
    542947726, -1047609569, 507250741, 1035751307, -502039364, 542947726, -943739490, 429446349, 958324201, -444968987,
    544995000, -1051701717, 509207261, 1035839473, -502229165, 544995000, -942503190, 427268492, 962017400, -448011351,
    547055523, -1055855728, 511213065, 1035956193, -502447657, 547055523, -941089647, 424969617, 965578640, -450958226,
    549130774, -1060074734, 513269973, 1036100110, -502693359, 549130774, -939496155, 422550049, 969011913, -453811298,
    551222259, -1064361672, 515379585, 1036269804, -502964731, 551222259, -937720119, 420010407, 972321228, -456572401,
    553331507, -1068719280, 517543273, 1036463810, -503260192, 553331507, -935759057, 417351601, 975510582, -459243495,
    555460072, -1073150100, 519762181, 1036680633, -503578144, 555460072, -933610600, 414574832, 978583948, -461826644,
    
    494084017, -851422604, 404056273, 930151631, -423619864, 494084017, -673714108, 339502486, 561843007, -265801750,
    498713542, -859177141, 406587077, 929211656, -423786402, 498713542, -673274906, 338185129, 573719128, -272222942,
    503369016, -867012190, 409148384, 928362985, -424054784, 503369016, -672533059, 336693984, 585290277, -278599028,
    508052536, -874935599, 411746438, 927604291, -424422151, 508052536, -671478538, 335026905, 596558312, -284920289,
    512766286, -882955583, 414387826, 926933782, -424885216, 512766286, -670100998, 333182045, 607525792, -291177811,
    517512534, -891080712, 417079474, 926349262, -425440318, 517512534, -668389789, 331157902, 618195914, -297363485,
    522293635, -899319903, 419828635, 925848177, -426083491, 522293635, -666333963, 328953368, 628572440, -303470012,
    527112032, -907682405, 422642886, 925427679, -426810526, 527112032, -663922286, 326567785, 638659631, -309490882,
    531970251, -916177781, 425530105, 925084675, -427617023, 531970251, -661143261, 324000998, 648462180, -315420352,
    536870912, -924815881, 428498454, 924815881, -428498454, 536870912, -657985147, 321253420, 657985147, -321253420,
    541816719, -933606817, 431556352, 924617870, -429450209, 541816719, -654435997, 318326093, 667233900, -326985786,
    546810467, -942560921, 434712438, 924487114, -430467639, 546810467, -650483688, 315220754, 676214053, -332613816,
    551855042, -951688708, 437975532, 924420027, -431546101, 551855042, -646115970, 311939896, 684931422, -338134495,
    556953421, -961000826, 441354588, 924413001, -432680993, 556953421, -641320513, 308486839, 693391970, -343545389,
    562108672, -970508005, 444858642, 924462435, -433867780, 562108672, -636084967, 304865786, 701601770, -348844597,
    567323959, -980220994, 448496743, 924564764, -435102022, 567323959, -630397020, 301081886, 709566963, -354030710,
    572602539, -990150500, 452277894, 924716482, -436379394, 572602539, -624244471, 297141281, 717293726, -359102767,
    577947763, -1000307125, 456210977, 924914158, -437695705, 577947763, -617615296, 293051155, 724788245, -364060214,
    583363084, -1010701292, 460304674, 925154455, -439046908, 583363084, -610497723, 288819761, 732056685, -368902865,
    
    387379495, -506912469, 196933274, 840112184, -347208270, 387379495, 506912469, 196933274, -840112184, -347208270,
    401658082, -532275898, 207149427, 833765363, -343175316, 401658082, 532275898, 207149427, -833765363, -343175316,
    416472483, -558722695, 217902617, 827270154, -339107319, 416472483, 558722695, 217902617, -827270154, -339107319,
    431841949, -586290861, 229212798, 820624988, -335007540, 431841949, 586290861, 229212798, -820624988, -335007540,
    447786335, -615019650, 241100489, 813828443, -330879528, 447786335, 615019650, 241100489, -813828443, -330879528,
    464326111, -644949597, 253586805, 806879270, -326727141, 464326111, 644949597, 253586805, -806879270, -326727141,
    481482377, -676122557, 266693475, 799776409, -322554559, 481482377, 676122557, 266693475, -799776409, -322554559,
    499276882, -708581728, 280442865, 792519013, -318366296, 499276882, 708581728, 280442865, -792519013, -318366296,
    517732032, -742371685, 294857996, 785106465, -314167221, 517732032, 742371685, 294857996, -785106465, -314167221,
    536870912, -777538408, 309962566, 777538408, -309962566, 536870912, 777538408, 309962566, -777538408, -309962566,
    556717294, -814129313, 325780968, 769814766, -305757943, 556717294, 814129313, 325780968, -769814766, -305757943,
    577295658, -852193284, 342338310, 761935777, -301559360, 577295658, 852193284, 342338310, -761935777, -301559360,
    598631206, -891780698, 359660433, 753902014, -297373230, 598631206, 891780698, 359660433, -753902014, -297373230,
    620749877, -932943463, 377773927, 745714425, -293206383, 620749877, 932943463, 377773927, -745714425, -293206383,
    643678365, -975735041, 396706151, 737374355, -289066077, 643678365, 975735041, 396706151, -737374355, -289066077,
    667444134, -1020210487, 416485252, 728883588, -284960004, 667444134, 1020210487, 416485252, -728883588, -284960004,
    692075438, -1066426476, 437140179, 720244375, -280896294, 692075438, 1066426476, 437140179, -720244375, -280896294,
    717601336, -1114441339, 458700704, 711459472, -276883515, 717601336, 1114441339, 458700704, -711459472, -276883515,
    744051710, -1164315096, 481197437, 702532174, -272930673, 744051710, 1164315096, 481197437, -702532174, -272930673
};

/* ----------------------------------------------------------------------
** Desired gains, in dB, per band
** ------------------------------------------------------------------- */
 
int gainDB[5] = {0, 0, 0, 0, 0};
#endif

#if (SIGNAL_PROCESS & 0x02)

#define NUM_TAPS              601
const float32_t firCoeffs32[NUM_TAPS] = {
  -6.002108785e-005,-5.88048315e-005,-5.75830054e-005,-5.635347406e-005,-5.511397831e-005,
  -5.386213525e-005,-5.259542741e-005,-5.131122452e-005,-5.000677993e-005,
  -4.867922326e-005,-4.732559319e-005,-4.594281563e-005,-4.452771827e-005,
  -4.307703784e-005,-4.158742377e-005,-4.005544906e-005,-3.847759945e-005,
  -3.685030242e-005,-3.516991637e-005,-3.343274147e-005,-3.163503425e-005,
  -2.97730021e-005,-2.784281605e-005,-2.584062167e-005,-2.376253724e-005,
  -2.160467011e-005,-1.936312037e-005,-1.703398993e-005,-1.461338434e-005,
  -1.209743186e-005,-9.482281712e-006,-6.764116733e-006,-3.939160706e-006,
  -1.003686748e-006,2.045973815e-006,5.213424174e-006,8.502192031e-006,1.191572392e-005,
  1.545736995e-005,1.913038795e-005,2.293791658e-005,2.688298628e-005,3.096849468e-005,
  3.519720849e-005,3.957175068e-005,4.409458779e-005,4.876803723e-005,5.359423812e-005,
  5.857515498e-005,6.371257041e-005,6.900807057e-005,7.446303789e-005,8.007865108e-005,
  8.585587784e-005,9.179545305e-005,9.789787146e-005,0.0001041634096,0.0001105920819,
  0.0001171836557,0.0001239376434,0.0001308532665,0.0001379295136,0.0001451650605,
  0.0001525583066,0.0001601073745,0.0001678100816,0.0001756639394, 0.000183666154,
  0.0001918136259,0.0002001029352,0.0002085303568,0.0002170918306,0.0002257829619,
  0.0002345990506,0.0002435350325, 0.000252585538,0.0002617448627,0.0002710069239,
  0.0002803653188,0.0002898133534,0.0002993438975,0.0003089495294,0.0003186225367,
  0.0003283547412,0.0003381377319,0.0003479626903, 0.000357820536, 0.000367701723,
  0.0003775965306,0.0003874947433,0.0003973859421,0.0004072593001, 0.000417103729,
  0.0004269077908,0.0004366597277,0.0004463474615,0.0004559586523,0.0004654806398,
  0.0004749004438,0.0004842048511,0.0004933802993,0.0005024130805,0.0005112890503,
  0.0005199938896,0.0005285131047,0.0005368319107,0.0005449351738,0.0005528077018,
  0.0005604340113,0.0005677984445, 0.000574885169,0.0005816781195,0.0005881610559,
  0.0005943176802,0.0006001314614,0.0006055857521,0.0006106637302,0.0006153485738,
  0.0006196232862,0.0006234707544,0.0006268739817,0.0006298156804,0.0006322786794,
  0.0006342456327, 0.000635699369,0.0006366225425,0.0006369978655, 0.000636808225,
   0.000636036275,0.0006346650189,0.0006326773437,0.0006300563109,0.0006267849822,
  0.0006228466518,0.0006182247307,0.0006129028043,0.0006068644579,0.0006000937428,
  0.0005925745936,0.0005842914106,0.0005752287689,0.0005653713015,0.0005547042238,
  0.0005432127509,0.0005308825057,  0.00051769946,0.0005036498769,0.0004887202522,
  0.0004728976346,0.0004561692767,0.0004385229258,0.0004199466202,0.0004004289221,
  0.0003799587721,0.0003585255472,0.0003361190902,0.0003127297678,0.0002883483248,
  0.0002629660885,0.0002365748805,0.0002091670322,0.0001807354274,0.0001512734743,
   0.000120775192,8.923510904e-005,5.664838682e-005,2.301075619e-005,-1.16814399e-005,
  -4.743124373e-005,-8.424107364e-005,-0.0001221127022,-0.0001610472973,-0.0002010453318,
  -0.000242106631,-0.0002842303948,-0.0003274150658,-0.0003716585052,-0.0004169578024,
  -0.0004633094068,-0.0005107090692,-0.0005591518129,-0.0006086319918,-0.0006591432029,
  -0.0007106784033,-0.0007632297347,-0.000816788699,-0.0008713460993,-0.0009268919821,
  -0.0009834156372,-0.001040905714,-0.001099350047,-0.001158735948,-0.001219049678,
  -0.001280277153, -0.00134240347,-0.001405412797,-0.001469288836,-0.001534014475,
  -0.001599572133,-0.001665943302,-0.001733108889,-0.001801049104,-0.001869743457,
  -0.001939170877,-0.002009309595,-0.002080137376,-0.002151631052,-0.002223767107,
  -0.002296521096,-0.002369868569,-0.002443783684,-0.002518240828,-0.002593213459,
  -0.002668674104, -0.00274459552,-0.002820949536, -0.00289770728,-0.002974840114,
  -0.003052318003,-0.003130110912,-0.003208188806,-0.003286520485,-0.003365074517,
  -0.003443819704,-0.003522723448,-0.003601753619, -0.00368087762,-0.003760062158,
   -0.00383927417,-0.003918480128,-0.003997645807,-0.004076736979,-0.004155720118,
    -0.0042345603,-0.004313223064,-0.004391673487,-0.004469876643,-0.004547798075,
  -0.004625401925, -0.00470265327,-0.004779517185,-0.004855958279,-0.004931941628,
  -0.005007432308,-0.005082394462,-0.005156793632,-0.005230594892,-0.005303763319,
  -0.005376264453, -0.00544806337,-0.005519126542,-0.005589419976,-0.005658908747,
  -0.005727560725,-0.005795341451,-0.005862218793,-0.005928160157,-0.005993132479,
  -0.006057104096,-0.006120044272,-0.006181921344,-0.006242704112,-0.006302363705,
  -0.006360868923,-0.006418191828,-0.006474302616,-0.006529173814,-0.006582777482,
  -0.006635087077,-0.006686075125,-0.006735716946, -0.00678398693,-0.006830859929,
  -0.006876312662, -0.00692032231,-0.006962865125,-0.007003920618,-0.007043466903,
  -0.007081483491,-0.007117951754,-0.007152852137,-0.007186166476, -0.00721787801,
  -0.007247970439,-0.007276427932,-0.007303235587,-0.007328379899,-0.007351847365,
  -0.007373625878,-0.007393703796,-0.007412071805,-0.007428719196,-0.007443637587,
  -0.007456819061,-0.007468257565,-0.007477946114,-0.007485880051,-0.007492055185,
  -0.007496468257,-0.007499116939,   0.9925000072,-0.007499116939,-0.007496468257,
  -0.007492055185,-0.007485880051,-0.007477946114,-0.007468257565,-0.007456819061,
  -0.007443637587,-0.007428719196,-0.007412071805,-0.007393703796,-0.007373625878,
  -0.007351847365,-0.007328379899,-0.007303235587,-0.007276427932,-0.007247970439,
   -0.00721787801,-0.007186166476,-0.007152852137,-0.007117951754,-0.007081483491,
  -0.007043466903,-0.007003920618,-0.006962865125, -0.00692032231,-0.006876312662,
  -0.006830859929, -0.00678398693,-0.006735716946,-0.006686075125,-0.006635087077,
  -0.006582777482,-0.006529173814,-0.006474302616,-0.006418191828,-0.006360868923,
  -0.006302363705,-0.006242704112,-0.006181921344,-0.006120044272,-0.006057104096,
  -0.005993132479,-0.005928160157,-0.005862218793,-0.005795341451,-0.005727560725,
  -0.005658908747,-0.005589419976,-0.005519126542, -0.00544806337,-0.005376264453,
  -0.005303763319,-0.005230594892,-0.005156793632,-0.005082394462,-0.005007432308,
  -0.004931941628,-0.004855958279,-0.004779517185, -0.00470265327,-0.004625401925,
  -0.004547798075,-0.004469876643,-0.004391673487,-0.004313223064,  -0.0042345603,
  -0.004155720118,-0.004076736979,-0.003997645807,-0.003918480128, -0.00383927417,
  -0.003760062158, -0.00368087762,-0.003601753619,-0.003522723448,-0.003443819704,
  -0.003365074517,-0.003286520485,-0.003208188806,-0.003130110912,-0.003052318003,
  -0.002974840114, -0.00289770728,-0.002820949536, -0.00274459552,-0.002668674104,
  -0.002593213459,-0.002518240828,-0.002443783684,-0.002369868569,-0.002296521096,
  -0.002223767107,-0.002151631052,-0.002080137376,-0.002009309595,-0.001939170877,
  -0.001869743457,-0.001801049104,-0.001733108889,-0.001665943302,-0.001599572133,
  -0.001534014475,-0.001469288836,-0.001405412797, -0.00134240347,-0.001280277153,
  -0.001219049678,-0.001158735948,-0.001099350047,-0.001040905714,-0.0009834156372,
  -0.0009268919821,-0.0008713460993,-0.000816788699,-0.0007632297347,-0.0007106784033,
  -0.0006591432029,-0.0006086319918,-0.0005591518129,-0.0005107090692,-0.0004633094068,
  -0.0004169578024,-0.0003716585052,-0.0003274150658,-0.0002842303948,-0.000242106631,
  -0.0002010453318,-0.0001610472973,-0.0001221127022,-8.424107364e-005,-4.743124373e-005,
  -1.16814399e-005,2.301075619e-005,5.664838682e-005,8.923510904e-005, 0.000120775192,
  0.0001512734743,0.0001807354274,0.0002091670322,0.0002365748805,0.0002629660885,
  0.0002883483248,0.0003127297678,0.0003361190902,0.0003585255472,0.0003799587721,
  0.0004004289221,0.0004199466202,0.0004385229258,0.0004561692767,0.0004728976346,
  0.0004887202522,0.0005036498769,  0.00051769946,0.0005308825057,0.0005432127509,
  0.0005547042238,0.0005653713015,0.0005752287689,0.0005842914106,0.0005925745936,
  0.0006000937428,0.0006068644579,0.0006129028043,0.0006182247307,0.0006228466518,
  0.0006267849822,0.0006300563109,0.0006326773437,0.0006346650189, 0.000636036275,
   0.000636808225,0.0006369978655,0.0006366225425, 0.000635699369,0.0006342456327,
  0.0006322786794,0.0006298156804,0.0006268739817,0.0006234707544,0.0006196232862,
  0.0006153485738,0.0006106637302,0.0006055857521,0.0006001314614,0.0005943176802,
  0.0005881610559,0.0005816781195, 0.000574885169,0.0005677984445,0.0005604340113,
  0.0005528077018,0.0005449351738,0.0005368319107,0.0005285131047,0.0005199938896,
  0.0005112890503,0.0005024130805,0.0004933802993,0.0004842048511,0.0004749004438,
  0.0004654806398,0.0004559586523,0.0004463474615,0.0004366597277,0.0004269077908,
   0.000417103729,0.0004072593001,0.0003973859421,0.0003874947433,0.0003775965306,
   0.000367701723, 0.000357820536,0.0003479626903,0.0003381377319,0.0003283547412,
  0.0003186225367,0.0003089495294,0.0002993438975,0.0002898133534,0.0002803653188,
  0.0002710069239,0.0002617448627, 0.000252585538,0.0002435350325,0.0002345990506,
  0.0002257829619,0.0002170918306,0.0002085303568,0.0002001029352,0.0001918136259,
   0.000183666154,0.0001756639394,0.0001678100816,0.0001601073745,0.0001525583066,
  0.0001451650605,0.0001379295136,0.0001308532665,0.0001239376434,0.0001171836557,
  0.0001105920819,0.0001041634096,9.789787146e-005,9.179545305e-005,8.585587784e-005,
  8.007865108e-005,7.446303789e-005,6.900807057e-005,6.371257041e-005,5.857515498e-005,
  5.359423812e-005,4.876803723e-005,4.409458779e-005,3.957175068e-005,3.519720849e-005,
  3.096849468e-005,2.688298628e-005,2.293791658e-005,1.913038795e-005,1.545736995e-005,
  1.191572392e-005,8.502192031e-006,5.213424174e-006,2.045973815e-006,-1.003686748e-006,
  -3.939160706e-006,-6.764116733e-006,-9.482281712e-006,-1.209743186e-005,
  -1.461338434e-005,-1.703398993e-005,-1.936312037e-005,-2.160467011e-005,
  -2.376253724e-005,-2.584062167e-005,-2.784281605e-005,-2.97730021e-005,
  -3.163503425e-005,-3.343274147e-005,-3.516991637e-005,-3.685030242e-005,
  -3.847759945e-005,-4.005544906e-005,-4.158742377e-005,-4.307703784e-005,
  -4.452771827e-005,-4.594281563e-005,-4.732559319e-005,-4.867922326e-005,
  -5.000677993e-005,-5.131122452e-005,-5.259542741e-005,-5.386213525e-005,
  -5.511397831e-005,-5.635347406e-005,-5.75830054e-005,-5.88048315e-005,-6.002108785e-005
};
static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];

arm_fir_instance_f32 S;

void SignalProcess_Fir(signed short * pTmp){

    int i;
    for (i = 0;i < BLOCK_SIZE;i++) {
        FIR_InputBuffer[i] = (float32_t)(pTmp[i]);
    }
    arm_fir_f32(&S, FIR_InputBuffer, FIR_OutputBuffer, BLOCK_SIZE);
    for (i = 0;i < BLOCK_SIZE;i++) {
        pTmp[i] = (unsigned short)(FIR_OutputBuffer[i]);
    }
    return;
}

#endif

#if (SIGNAL_PROCESS & 0x01)

arm_biquad_cas_df1_32x64_ins_q31 S1;
arm_biquad_cas_df1_32x64_ins_q31 S2;
arm_biquad_casd_df1_inst_q31 S3;
arm_biquad_casd_df1_inst_q31 S4;
arm_biquad_casd_df1_inst_q31 S5;

void SignalProcess_Equalizer(unsigned short * pTmp){

    int i;

    for (i = 0;i < BLOCK_SIZE;i++) {
        FIR_InputBuffer[i] = ((float32_t)(pTmp[i]))/65536.0f;
    }
    /* ----------------------------------------------------------------------
    ** Convert block of input data from float to Q31
    ** ------------------------------------------------------------------- */

    arm_float_to_q31(FIR_InputBuffer, inputQ31, BLOCK_SIZE);

    /* ----------------------------------------------------------------------
    ** Scale down by 1/8.  This provides additional headroom so that the
    ** graphic EQ can apply gain.
    ** ------------------------------------------------------------------- */

    arm_scale_q31(inputQ31, 0x7FFFFFFF, -3, inputQ31, BLOCK_SIZE);

    /* ----------------------------------------------------------------------
    ** Call the Q31 Biquad Cascade DF1 32x64 process function for band1, band2
    ** ------------------------------------------------------------------- */

    arm_biquad_cas_df1_32x64_q31(&S1, inputQ31, outputQ31, BLOCK_SIZE);
    arm_biquad_cas_df1_32x64_q31(&S2, outputQ31, outputQ31, BLOCK_SIZE);

    /* ----------------------------------------------------------------------
    ** Call the Q31 Biquad Cascade DF1 process function for band3, band4, band5
    ** ------------------------------------------------------------------- */

    arm_biquad_cascade_df1_q31(&S3, outputQ31, outputQ31, BLOCK_SIZE);
    arm_biquad_cascade_df1_q31(&S4, outputQ31, outputQ31, BLOCK_SIZE);
    arm_biquad_cascade_df1_q31(&S5, outputQ31, outputQ31, BLOCK_SIZE);

    /* ----------------------------------------------------------------------
    ** Convert Q31 result back to float
    ** ------------------------------------------------------------------- */

    arm_q31_to_float(outputQ31, FIR_OutputBuffer, BLOCK_SIZE);

    /* ----------------------------------------------------------------------
    ** Scale back up
    ** ------------------------------------------------------------------- */

    arm_scale_f32(FIR_OutputBuffer, 8.0f, FIR_OutputBuffer, BLOCK_SIZE);
    for (i = 0;i < BLOCK_SIZE;i++) {
        if (FIR_OutputBuffer[i] > 0) {
            pTmp[i] = (unsigned short)(FIR_OutputBuffer[i] * 65536);
        }else{
            pTmp[i] = 32768;
        }
    }
}
#endif

#if( DENOISE_PROCESS == DENOISE_DEFAULT || DENOISE_PROCESS == DENOISE_SS_1)
/* Spectral Subtract */
void SpectralSubtract(float * SrcSpecArray,float * NoiseMagArray){
    /* SrcArray is Spectral array,is after fft and include real and imaginary,
       SrcArray = [a0,i*b0,a1,i*b1],length == SAMPLE_SIZE * 2 */
    int i;
    float SrcSpecMag[BLOCK_SIZE];

    arm_cmplx_mag_f32(SrcSpecArray,SrcSpecMag,BLOCK_SIZE);
#if (DENOISE_PROCESS == DENOISE_DEFAULT)
    float tmp;
    for (i = 0;i < BLOCK_SIZE;i++) {
        if (SrcSpecMag[i] > NoiseMagArray[i]) {
            tmp = (SrcSpecMag[i] - NoiseMagArray[i])/SrcSpecMag[i];
            SrcSpecArray[2 * i] *= tmp;
            SrcSpecArray[2*i + 1] *= tmp;
        }else{
            SrcSpecArray[2 * i] = 0;
            SrcSpecArray[2*i + 1] = 0;
        }
    }
#else
    float tmp;
    for (i = 0;i < BLOCK_SIZE; i++) {
        float ar, ai;
        if (SrcSpecMag[i] > 0){
            ar = SrcSpecArray[2 * i]/SrcSpecMag[i];
            ai = SrcSpecArray[2 * i + 1]/SrcSpecMag[i];
       
            /*************************************************
             *kk = pow(power, 0.4) - 0.9 * pow(noise[j], 0.4);
             *if (kk < 0) kk = 0;
             *kk = pow(kk, (1/0.4));
             *power = kk; 
             *            
             *Here power is the real part of SrcSpecArray.            
             *************************************************/            
            //Simplified version algorithm: replace 0.4 with 0.5.
            tmp = sqrtf(SrcSpecMag[i]) - 0.9f * sqrtf(NoiseMagArray[i]);
            if ( tmp > 0) tmp *= tmp;
            else tmp = 0;          
        }else{
            ar = ai = tmp = 0.0;
        }
        
        SrcSpecArray[2 * i] = ar*tmp;
        SrcSpecArray[2*i + 1] = ai*tmp;
    }
#endif
    
    return;
}

const float HanmmingArray[] = {
    0.080000,0.080140,0.080558,0.081256,0.082232,0.083487,0.085018,0.086825,
    0.088908,0.091264,0.093893,0.096793,0.099962,0.103398,0.107099,0.111063,
    0.115287,0.119769,0.124506,0.129496,0.134734,0.140219,0.145946,0.151913,
    0.158115,0.164549,0.171211,0.178097,0.185203,0.192524,0.200056,0.207794,
    0.215734,0.223871,0.232200,0.240716,0.249413,0.258287,0.267332,0.276542,
    0.285912,0.295437,0.305110,0.314925,0.324878,0.334960,0.345168,0.355493,
    0.365931,0.376474,0.387117,0.397852,0.408674,0.419575,0.430550,0.441591,
    0.452691,0.463845,0.475045,0.486285,0.497557,0.508854,0.520171,0.531500,
    0.542834,0.554166,0.565489,0.576797,0.588083,0.599340,0.610560,0.621738,
    0.632866,0.643938,0.654946,0.665885,0.676747,0.687527,0.698217,0.708810,
    0.719302,0.729684,0.739951,0.750097,0.760115,0.770000,0.779745,0.789345,
    0.798793,0.808084,0.817212,0.826172,0.834958,0.843565,0.851988,0.860222,
    0.868261,0.876100,0.883736,0.891163,0.898377,0.905373,0.912148,0.918696,
    0.925015,0.931100,0.936947,0.942554,0.947916,0.953030,0.957894,0.962504,
    0.966858,0.970952,0.974785,0.978353,0.981656,0.984690,0.987455,0.989948,
    0.992168,0.994113,0.995782,0.997175,0.998290,0.999128,0.999686,0.999965,
    0.999965,0.999686,0.999128,0.998290,0.997175,0.995782,0.994113,0.992168,
    0.989948,0.987455,0.984690,0.981656,0.978353,0.974785,0.970952,0.966858,
    0.962504,0.957894,0.953030,0.947916,0.942554,0.936947,0.931100,0.925015,
    0.918696,0.912148,0.905373,0.898377,0.891163,0.883736,0.876100,0.868261,
    0.860222,0.851988,0.843565,0.834958,0.826172,0.817212,0.808084,0.798793,
    0.789345,0.779745,0.770000,0.760115,0.750097,0.739951,0.729684,0.719302,
    0.708810,0.698217,0.687527,0.676747,0.665885,0.654946,0.643938,0.632866,
    0.621738,0.610560,0.599340,0.588083,0.576797,0.565489,0.554166,0.542834,
    0.531500,0.520171,0.508854,0.497557,0.486285,0.475045,0.463845,0.452691,
    0.441591,0.430550,0.419575,0.408674,0.397852,0.387117,0.376474,0.365931,
    0.355493,0.345168,0.334960,0.324878,0.314925,0.305110,0.295437,0.285912,
    0.276542,0.267332,0.258287,0.249413,0.240716,0.232200,0.223871,0.215734,
    0.207794,0.200056,0.192524,0.185203,0.178097,0.171211,0.164549,0.158115,
    0.151913,0.145946,0.140219,0.134734,0.129496,0.124506,0.119769,0.115287,
    0.111063,0.107099,0.103398,0.099962,0.096793,0.093893,0.091264,0.088908,
    0.086825,0.085018,0.083487,0.082232,0.081256,0.080558,0.080140,0.080000,
};

const float HanmmingSubArray[] = {
    1.079965,1.079826,1.079686,1.079546,1.079407,1.079269,1.079131,1.078993,
    1.078856,1.078719,1.078583,1.078449,1.078315,1.078183,1.078051,1.077921,
    1.077791,1.077663,1.077536,1.077412,1.077288,1.077166,1.077046,1.076928,
    1.076811,1.076697,1.076584,1.076474,1.076366,1.076260,1.076156,1.076055,
    1.075956,1.075859,1.075765,1.075674,1.075585,1.075499,1.075416,1.075335,
    1.075257,1.075182,1.075110,1.075040,1.074975,1.074911,1.074852,1.074795,
    1.074741,1.074691,1.074644,1.074599,1.074559,1.074521,1.074488,1.074457,
    1.074429,1.074405,1.074385,1.074368,1.074354,1.074343,1.074337,1.074334,
    1.074334,1.074337,1.074343,1.074354,1.074368,1.074385,1.074405,1.074429,
    1.074457,1.074488,1.074521,1.074559,1.074599,1.074644,1.074691,1.074741,
    1.074795,1.074852,1.074911,1.074975,1.075040,1.075110,1.075182,1.075257,
    1.075335,1.075416,1.075499,1.075585,1.075674,1.075765,1.075859,1.075956,
    1.076055,1.076156,1.076260,1.076366,1.076474,1.076584,1.076697,1.076811,
    1.076928,1.077046,1.077166,1.077288,1.077412,1.077536,1.077663,1.077791,
    1.077921,1.078051,1.078183,1.078315,1.078449,1.078583,1.078719,1.078856,
    1.078993,1.079131,1.079269,1.079407,1.079546,1.079686,1.079826,1.079965,
    1.079965,1.079826,1.079686,1.079546,1.079407,1.079269,1.079131,1.078993,
    1.078856,1.078719,1.078583,1.078449,1.078315,1.078183,1.078051,1.077921,
    1.077791,1.077663,1.077536,1.077412,1.077288,1.077166,1.077046,1.076928,
    1.076811,1.076697,1.076584,1.076474,1.076366,1.076260,1.076156,1.076055,
    1.075956,1.075859,1.075765,1.075674,1.075585,1.075499,1.075416,1.075335,
    1.075257,1.075182,1.075110,1.075040,1.074975,1.074911,1.074852,1.074795,
    1.074741,1.074691,1.074644,1.074599,1.074559,1.074521,1.074488,1.074457,
    1.074429,1.074405,1.074385,1.074368,1.074354,1.074343,1.074337,1.074334,
    1.074334,1.074337,1.074343,1.074354,1.074368,1.074385,1.074405,1.074429,
    1.074457,1.074488,1.074521,1.074559,1.074599,1.074644,1.074691,1.074741,
    1.074795,1.074852,1.074911,1.074975,1.075040,1.075110,1.075182,1.075257,
    1.075335,1.075416,1.075499,1.075585,1.075674,1.075765,1.075859,1.075956,
    1.076055,1.076156,1.076260,1.076366,1.076474,1.076584,1.076697,1.076811,
    1.076928,1.077046,1.077166,1.077288,1.077412,1.077536,1.077663,1.077791,
    1.077921,1.078051,1.078183,1.078315,1.078449,1.078583,1.078719,1.078856,
    1.078993,1.079131,1.079269,1.079407,1.079546,1.079686,1.079826,1.079965,
};

void HanmmingFunction(float * SrcSignalArray,int AddWindow){

    int i;
    for (i = 0;i < BLOCK_SIZE;i++) {
        if (AddWindow) {
            SrcSignalArray[i] *= HanmmingArray[i];
        }else{
            SrcSignalArray[i] /= HanmmingArray[i];
        }
    }
    return;
}

void HanmmingSubWindow(float * SrcSignalArray){

    int i;
    for (i = 0;i < BLOCK_SIZE;i++) {
        SrcSignalArray[i] = (SrcSignalArray[i])/(HanmmingSubArray[i]);
    }
    return;
}

float NoiseMagArray[BLOCK_SIZE];

void NoiseEstimate(signed short * noise,int frameNumber){

    int i,frame;
    float Array[BLOCK_SIZE * 2];
    float Mag[BLOCK_SIZE];

    for (frame = 0;frame < frameNumber;frame++) {
        /* change to float */
        for (i = 0;i < BLOCK_SIZE;i++) {
            Array[i] = ((float)(noise[i]))/32768.0f;
        }
        //HanmmingFunction(Array,1);//add hanmming window
        /* change to complex array */
        for (i = (BLOCK_SIZE - 1);i >= 0;i--) {
            Array[2 * i] = Array[i];
            Array[2 * i + 1] = 0.0;
        }
        /* ok,FFT */
        arm_cfft_f32(&arm_cfft_sR_f32_len256,Array,0,1);

        arm_cmplx_mag_f32(Array,Mag,BLOCK_SIZE);
        for (i = 0;i < BLOCK_SIZE;i++) {
            if (0 == frame) {
                NoiseMagArray[i] = (float)(Mag[i]);
            }else{
                NoiseMagArray[i] += (float)(Mag[i]);
            }
        }
        noise += BLOCK_SIZE/2;
    }
    for (i = 0;i < BLOCK_SIZE;i++) {
        NoiseMagArray[i] /= frameNumber;
        NoiseMagArray[i] *= 1.6f;
    }
    return;
}

void Denoise(signed short * SrcSignalArray,const unsigned int SrcSignalArrayLen,unsigned int * SrcSignalArrayPos){

    int i;
    float Array[BLOCK_SIZE * 2];
    static float SignalShiftArray[BLOCK_SIZE*2] = {0.0};

    /* change to float */
    for (i = 0;i < BLOCK_SIZE;i++) {
        Array[i] = ((float)(SrcSignalArray[((*SrcSignalArrayPos) + i)%SrcSignalArrayLen]))/32768.0f;
    }
    
    /* add hanmming window */
    HanmmingFunction(Array,1);
    
    /* change to complex array */
    for (i = (BLOCK_SIZE - 1);i >= 0;i--) {
        Array[2 * i] = Array[i];
        Array[2 * i + 1] = 0.0;
    }
    arm_cfft_f32(&arm_cfft_sR_f32_len256,Array,0,1);
    
    /* spectral sub */
    SpectralSubtract(Array,NoiseMagArray);
    
    arm_cfft_f32(&arm_cfft_sR_f32_len256,Array,1,1);
    
   
    /* store real number array */
    for (i = 0;i < BLOCK_SIZE;i++) {
        if (i < (BLOCK_SIZE/2)) {
            SignalShiftArray[(i + (*SrcSignalArrayPos)) % (BLOCK_SIZE * 2)] += Array[2 * i];
        }else{
            SignalShiftArray[(i + (*SrcSignalArrayPos)) % (BLOCK_SIZE * 2)] = Array[2 * i];
        }
    }
    
    (*SrcSignalArrayPos) += BLOCK_SIZE/2;
    if (0 == ((*SrcSignalArrayPos)%BLOCK_SIZE)) {
        i = (*SrcSignalArrayPos) - BLOCK_SIZE;
        HanmmingSubWindow(SignalShiftArray + (i%(BLOCK_SIZE*2)));
        for (;i < (*SrcSignalArrayPos);i++) {
            SrcSignalArray[i % SrcSignalArrayLen] = (signed short)(SignalShiftArray[i%(BLOCK_SIZE*2)] * 32768);
        }
    }
    
    return;
}
#endif

void SignalProcess_Init(signed short * noise, int frameNumber){
#if (DENOISE_PROCESS == DENOISE_WEBRTC)
    NsInit( SAMPLE_RATE, 1 );
#if (VAD_ENABLE == 2 )  
    VadInit( SAMPLE_RATE, 2 );
#endif  
    NoiseSample_Start();
    while( frameNumber ){
        if ( SenderSC.SampleCurPos - SenderSC.DenoisePos > DATALEN_PER_RAWFRAME ){
            short* src = (short *)SenderSC.SampleBufPointer;
            NsAnalyze(&src[SenderSC.DenoisePos%SenderSC.SampleBufLen]);
            SenderSC.DenoisePos += BLOCK_SIZE;    
            frameNumber--;
        }
    }
    NoiseSample_Stop();
#else
    NoiseEstimate(noise,frameNumber);
#endif    
    
#if (SIGNAL_PROCESS & 0x01)
    arm_biquad_cas_df1_32x64_init_q31(&S1, NUMSTAGES,(q31_t *) &coeffTable[190*0 + 10*(gainDB[0] + 9)],&biquadStateBand1Q31[0], 2);
    arm_biquad_cas_df1_32x64_init_q31(&S2, NUMSTAGES,(q31_t *) &coeffTable[190*1 + 10*(gainDB[1] + 9)],&biquadStateBand2Q31[0], 2);
    arm_biquad_cascade_df1_init_q31(&S3, NUMSTAGES,(q31_t *) &coeffTable[190*2 + 10*(gainDB[2] + 9)],&biquadStateBand3Q31[0], 2);
    arm_biquad_cascade_df1_init_q31(&S4, NUMSTAGES,(q31_t *) &coeffTable[190*3 + 10*(gainDB[3] + 9)],&biquadStateBand4Q31[0], 2);
    arm_biquad_cascade_df1_init_q31(&S5, NUMSTAGES,(q31_t *) &coeffTable[190*4 + 10*(gainDB[4] + 9)],&biquadStateBand5Q31[0], 2);
#endif    
#if (SIGNAL_PROCESS & 0x02)
    arm_fir_init_f32(&S, NUM_TAPS, (float32_t *)&firCoeffs32[0], &firStateF32[0], BLOCK_SIZE);
#endif    
    
    return;
}

void SignalProcess_Run(signed short * SrcSignalArray, const unsigned int SrcSignalArrayLen, unsigned int * SrcSignalArrayPos){
#if (DENOISE_PROCESS != DENOISE_NONE)
#if (DENOISE_PROCESS == DENOISE_WEBRTC)
    short* src = &SrcSignalArray[((*SrcSignalArrayPos)%SrcSignalArrayLen)];
    NsProcess(src);    
    *SrcSignalArrayPos += BLOCK_SIZE;    
#else    
    Denoise(SrcSignalArray,SrcSignalArrayLen,SrcSignalArrayPos);
#if (SIGNAL_PROCESS & 0x02)
    if ((*SrcSignalArrayPos%BLOCK_SIZE)==0){
        SignalProcess_Fir(SrcSignalArray + ((*SrcSignalArrayPos) - BLOCK_SIZE) %SrcSignalArrayLen);
    }
#endif  
#if (SIGNAL_PROCESS & 0x01)
    if ((*SrcSignalArrayPos%BLOCK_SIZE)==0){
        SignalProcess_Equalizer((unsigned short *)SrcSignalArray + ((*SrcSignalArrayPos) - BLOCK_SIZE) %SrcSignalArrayLen);
    }
#endif  
#endif    
#else
    SrcSignalArrayPos += BLOCK_SIZE;
#endif
    return;
}



